`comment("=== PB-T1068-001 - Exploitation for Privilege Escalation Detection ===")`
`comment("MITRE ATT&CK: T1068 - privilege-escalation")`

`comment("Suspicious Parent-Child with Privilege Elevation")`
index=sysmon EventCode=1
| rex field=User "(?<user_name>[^\\]+)$"
| where (Image="*\cmd.exe" OR Image="*\powershell.exe") AND IntegrityLevel="High" AND ParentIntegrityLevel="Medium"
| table _time, ComputerName, User, Image, ParentImage, IntegrityLevel, CommandLine

`comment("Known Vulnerable Driver Loading")`
index=sysmon EventCode=6
| lookup vulnerable_drivers driver_name as ImageLoaded OUTPUT vulnerability_cve
| where isnotnull(vulnerability_cve)
| table _time, ComputerName, ImageLoaded, Signature, vulnerability_cve

`comment("Token Manipulation Detection")`
index=windows sourcetype=windows:security EventCode=4673
| where ProcessName!="*\lsass.exe" AND PrivilegeList LIKE "%SeDebugPrivilege%"
| table _time, ComputerName, SubjectUserName, ProcessName, PrivilegeList

`comment("UAC Bypass Indicators")`
index=sysmon EventCode=1
| where IntegrityLevel="High" AND (ParentImage="*\eventvwr.exe" OR ParentImage="*\fodhelper.exe" OR ParentImage="*\computerdefaults.exe")
| table _time, ComputerName, User, Image, ParentImage, CommandLine